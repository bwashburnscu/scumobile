<!DOCTYPE html> 
<html> 
	<head> 
	<title>Directory</title> 
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.css" />
	<link rel="stylesheet" href="../assets/scu.css" />
	<link rel="stylesheet" href="../assets/secondary.css" />
	<script src="http://code.jquery.com/jquery-1.10.0.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.3.1/jquery.mobile-1.3.1.min.js"></script>

	<script>
	   $(document).ready(function() {
	   	if($('#primary-nav').length == 0) {
	   		$('.pnav-icon').hide();
	   		}
	   });
   
	   
		function getUrlVars() {
		var vars = [], hash;
		var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
		for(var i = 0; i < hashes.length; i++)
		    {
		        hash = hashes[i].split('=');
		        vars.push(hash[0]);
		        vars[hash[0]] = hash[1];
		    }
		return vars;
		}
	</script>
   
	</head> 
<body> 

<div class="navpage" data-role="page" class="type-interior">
	
	<div data-role="header">
		<a rel="external" href="../index.html" data-role="none" data-direction="reverse" class="ui-btn-left"><img width="108" height="40" class="sculogo" alt="" src="../assets/scu-home.png" /></a>
		<h1>Directory</h1>
		<a href="#" onclick="$.mobile.silentScroll($.mobile.activePage.find('#primary-nav').position().top)" data-role="none" class="pnav-icon"><img alt="" src="../assets/259-list-w.png" /></a>
	</div><!-- /header -->

	<div data-role="content">
    <div class="content-primary">
		<form data-ajax="false" id='searchForm' name='searchForm' action="search.html" method="get" class="ui-body ui-body-d ui-corner-all">
			<fieldset>
				<label for="search-basic" class="ui-hidden-accessible">Search Input:</label>
				<input type="search" name="q" id="search-basic" value="" />
			</fieldset>
		</form>
    	<div data-role="collapsible-set" id="srPeople">
		</div>
    	<div data-role="collapsible-set" id="srOrgs">
		</div>
		<script type="text/javascript">
			var pstr = '';
			var ostr = '';
			var q = getUrlVars()["q"];
	    	jQuery(function($){
		    $.ajax({
		            url: "http://test01.scu.edu/docs/ws/directory/index.cfc?method=queryPeople&q="+q+"&ReturnFormat=json",
		            dataType: 'json',
		            async:false,
		            success: function(response) {
		            var i;
		            //"PERNAME","LAST_NAME","PREFIX","SUFFIX","MIDDLE","PERSON_ID","TITLE","EMAIL","EMAIL_PREF","PICTURE_FILENAME","DESCRIPTION","PROFILE_PREF","PHONE","PHONE_PREF","ORGNAME","ORG_ID","AREACODE","ORGPHONE"]
		            // this is where we determine what information will be displayed based on SCU login and display settings
					//var onCampus = false;
					var showemail = false;
					var showemailform = false;
					var showphoto = false;
					var showphone = '';
					var showdescription = false;

		            var pcount = response.DATA.length;
		    		var collapsestate = '';
		    		var personid = '';
		    		var lastperson = '';
		    		var imgpath = 'http://phonebook.scu.edu/utility/phonebook/customcf/uploads/';
		            if (pcount > 0) {
		            	if (pcount == 1) {
		            		collapsestate = ' data-collapsed="false"';
		            	}
			        	for (i = 0; i < response.DATA.length; i++) {
			        		//show email address
							if ((response.DATA[i][8] == 1) && (response.DATA[i][7].length > 0)) {
								showemail = true;
							}
							
							//show email form
							if ((response.DATA[i][8] < 3) && (response.DATA[i][7].length > 0)) {
								showemailform = true;
							}
							
							//show personal photo
							if (response.DATA[i][9] != null && response.DATA[i][9].length > 0 && response.DATA[i][11] == 1) {
								showphoto = true;
							}
							
							//show direct phone number
							if (response.DATA[i][12].length && response.DATA[i][13] == 1) {
								showphone = response.DATA[i][12];
							} else {
								showphone = response.DATA[i][17];
							}
							
							if (showphone.indexOf('408') == -1 && showphone.length <= 8 && showphone.length >= 7) {
								showphone = '408-' + showphone;
							}
							
			        		personid = response.DATA[i][5];
							if (personid != lastperson) {
								pstr += '<div data-role="collapsible" '+collapsestate+'>';
								pstr += "<h3>" + response.DATA[i][1] + ", " + response.DATA[i][0] + "</h3>";
								pstr += '<h5><a rel="external" href="org.html?oid='+response.DATA[i][15]+'">' + response.DATA[i][14] + '</a></h5>';
								pstr += '<p><a href="tel:'+showphone+'">'+showphone+'</a></p>';
								pstr += '<p><a href="mailto:'+response.DATA[i][7]+'">'+response.DATA[i][7]+'</a></p>';
								if(response.DATA[i][10] != null && response.DATA[i][10].length > 0) {
								pstr += '<div>' + response.DATA[i][10] + '</div>';
								}
								if (showphoto) {
								pstr += '<p><img style="width:100%;" src="' + imgpath + response.DATA[i][9] + '" /></p>';	
								}
								pstr += '</div>';
							}
							lastperson = response.DATA[i][5];
						}
					$('#srPeople').html(pstr);
			        $('#srPeople').collapsibleset('refresh');
			    	}
			    }
			    ,
			    error: function(ErrorMsg) {
			       alert('Error');
			    }
			  });
		    $.ajax({
		            url: "http://test01.scu.edu/docs/ws/directory/index.cfc?method=queryOrgs&q="+q+"&ReturnFormat=json",
		            dataType: 'json',
		            async:false,
		            success: function(response) {
		            var i;
		            //["ORG_ID","NAME","EMAIL","DESCR_FULL","PHONE"]
		            var ocount = response.DATA.length;
		    		var collapsestate = '';
		    		var orgid = '';
		            if (ocount > 0) {
		            	if (ocount == 1) {
		            		collapsestate = ' data-collapsed="false"';
		            	}
			        	for (i = 0; i < response.DATA.length; i++) {
			        		var orgphone = response.DATA[i][4];
							if (orgphone.indexOf('408') == -1 && orgphone.length <= 8 && orgphone.length >= 7) {
								orgphone = '408-' + orgphone;
							}
			        		orgid = response.DATA[i][0];
							ostr += '<div data-role="collapsible" '+collapsestate+'>';
							ostr += '<h3>' + response.DATA[i][1] + '</h3>';
							ostr += '<p><a href="tel:'+orgphone+'">'+orgphone+'</a></p>';
							ostr += '<p><a href="mailto:'+response.DATA[i][2]+'">'+response.DATA[i][2]+'</a></p>';
							ostr += '<div>' + response.DATA[i][3] + '</div>';
							ostr += '<div><a rel="external" href="org.html?oid='+orgid+'" >View full staff listing</a></div>';
							ostr += '</div>';
						}
					$('#srOrgs').html(ostr);
			        $('#srOrgs').collapsibleset('refresh');
			    	}
			    }
			    ,
			    error: function(ErrorMsg) {
			       alert('Error');
			    }
			  });
	    });
	    </script>
	</div>
	<div id="primary-nav" class="content-secondary">
		<ul data-role="listview" class="ui-listview"></ul>
		<script>
			var navstring = 'directory';
		</script>
	    <script src="../assets/nav.js"></script>
	</div>
	</div>

	<div data-role="footer" data-theme="c">
		<p style="text-align:center;">&copy; 2013 Santa Clara University</p>
	</div><!-- /footer -->
</div><!-- /page -->

<script>
$(document).ready(function(){
	var q = getUrlVars()["q"];
	if (q == 'undefined') {
	q = '';
	}
	$('input').val(q);
	});		
</script>

</body>
</html>